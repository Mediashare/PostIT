{# Dependencies #}
<script src="{{ asset('codemirror/lib/codemirror.js') }}"></script>
<link rel="stylesheet" href="{{ asset('codemirror/lib/codemirror.css') }}">
<script src="{{ asset('codemirror/mode/markdown/markdown.js') }}"></script>

{# AutoCompletion #}
<script src="{{ asset('codemirror/addon/hint/anyword-hint.js') }}"></script>
<script src="{{ asset('codemirror/addon/hint/css-hint.js') }}"></script>
<script src="{{ asset('codemirror/addon/hint/html-hint.js') }}"></script>
<script src="{{ asset('codemirror/addon/hint/javascript-hint.js') }}"></script>
<script src="{{ asset('codemirror/addon/hint/show-hint.js') }}"></script>
<script src="{{ asset('codemirror/addon/hint/sql-hint.js') }}"></script>
<script src="{{ asset('codemirror/addon/hint/xml-hint.js') }}"></script>
<script src="{{ asset('codemirror/keymap/sublime.js') }}"></script>
<link rel="stylesheet" href="{{ asset('codemirror/addon/hint/show-hint.css') }}">

<div id="codemirror" class="shadow-lg rounded"></div>
<textarea name="content" id="content_mirror" class="d-none" required></textarea>

{% if post is defined %} {% set content = post.content %}
{% else %} {% set content = "# Hello world\n" %} {% endif %}
<script>
    var myCodeMirror = CodeMirror(document.getElementById('codemirror'), {
            value: "{{- content|escape("js") -}}",
            mode:  "markdown",
            lineNumbers: true,
            extraKeys: {"Ctrl-Space": "autocomplete"},
            keyMap: "sublime"
    });
    myCodeMirror.setSize('100%', '100vh');
    $('textarea#content_mirror').val(myCodeMirror.getValue());

    refreshPreview(myCodeMirror.getValue());
    myCodeMirror.on('change', function (CodeMirror) {
        refreshPreview(CodeMirror.getValue());
    });
    
    function refreshPreview(content) {
        $('textarea#content_mirror').val(content);
        $.post('{{ path("markdownify") }}', {content: content}, function (data) {
            $('.markdown-body').html(data);
            document.querySelectorAll('.markdown-body pre code').forEach((block) => {
                hljs.highlightBlock(block);
            });
        });
    }
</script>
